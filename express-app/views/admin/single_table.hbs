<p>
  <a href="/admin/tables/table/{{table._id}}"><i class="material-icons">autorenew</i></a> |
  <a href="/admin/tables">Back</a>
</p>

<h4 class="tableHeading">Table: {{table.number}}</h4>
<a href="#" data-id="{{table._id}}" class="deleteTableBtn waves-effect waves-light btn">Remove</a>
<br>
<br>
<div class="createOrderDiv">
  <form class="" action="/admin/table/{{table._id}}/createNewOrder" method="post">
    <label class="labelForOrderName" for="orderName">Order name:</label>
    <input type="text" name="newOrderName" id="orderName" class="newOrderNameInput">
    <button type="submit" class="createOrderBtn">Create order</button>
  </form>
</div>
<br>
<br>
<button type="button" class="addInputField"  onclick="addArticleInput()">+</button>
<!-- List of orders -->
<div class="listOfOrders">
    {{#each ordersResponse.orders as |order|}}

    <div class="singleOrder">
      <div id="currentOrderForm" class="collection">
        <input id="inWhichOrderId" class="inWhichOrder" name="inWhichOrder" value="{{_id}}">

        <h4 class="orderHeading">Order: {{name}}</h4>
        <a href="#" class="deleteOrderBtn" data-name="{{name}}" data-id="{{_id}}">Delete order</a>
        <!-- Forms for reserving articles -->
        <div class="reservedArticleDiv collection-item" id="reservedArticleDiv">
          <form class="articleInputForm" action="/admin/order/reserve-article" method="post">
            <!-- Preview article image -->
            <img id="previewReservingImage" class="reserveArticleImg">
            <input type="text" id="inputPreviewImage" name="previewArticleImage">
            <input id="reservedArticleId" type="text" name="articleId">
            <!-- Dropdown for articles -->
            <div class="input-field col reservedArticleInput">
              <select id="dropdwn">
                <option value="" disabled selected>Select</option>
                {{#each ../articlesResponse.articles as |article|}}
                  <option class="optionn" value="{{name}}" data-id="{{_id}}" data-img="/../../{{image}}">{{name}}</option>
                {{/each}}
              </select>
            </div>
            <p class="timesSign">X</p>
            <!-- Quantity input -->
            <input required type="number" value="0" name="reservedArticleQuantity"
              class="qtyInput"
              oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
              type = "number"
              maxlength = "2">
            <button type="button" class="cancelArticleBtn" id="cancelArticleBtn" onclick="cancelArticleInput()">x</button>
            <button type="submit" class="submitArticleBtn" id="submitArticleBtn">Reserve</button>
          </form>
        </div>
      </div>

      <!-- List of reserved articles -->
      <ul class="collection reservedArticlesUl">
        <h5>Reserved</h5>
        {{#each ../reservedArticlesResponse.reservedArticles as |reservedArticle|}}
        <li class="collection-item reservedArticleLi">
          <img src="{{image}}" class="reservedArticleImg">
          <p class="reservedArticleInfo">
            Reserved: {{name}} <br>
            Quantity: {{quantity}}
          </p>
          <div>
            <a href="#" class="deleteReservedArticle waves-effects btn red lighten-1" data-id="{{_id}}">X</a>
          </div>
        </li>
        {{/each}}
      </ul>
    </div>

    {{/each}}
</div>

<div class="singleTableArticleSearch">
  <form id="singleTableSearchArticlesForm">
    <input type="text" id="searchArticleSingleTableInput" placeholder="Search.."/>
  </form>
</div>

<div>
  <ul id="singleTableArticleList" class="collection singleTableArticleList">
    {{#each articlesResponse.articles as |article|}}
      <li class="collection-item singleTableArticleLi">
        <a href="/admin/table/addArticle/{{_id}}">
          <span id="articleNameSingleTable">{{name}}</span>
           - ({{quantity}})
        </a>
      </li>
    {{/each}}
  </ul>
</div>

<script>
  // Get value from dropdown and assign article value
  const getDropdown = document.getElementById('dropdwn');
  getDropdown.addEventListener('change', function(){
    let getVal = document.getElementById('dropdwn').value;
    console.log(getVal);
    getDropdown.setAttribute('name', 'reservedArticleName');
    getDropdown.value = getVal;

    // Get preview image
    const nImg = document.getElementById('dropdwn');
    let getAttrib = $(this).find(':selected').data('img');
    let previewImage = document.getElementById('previewReservingImage');
    const imgUrl = `/../../..${getAttrib}`;
    previewImage.src = imgUrl;
    console.log(imgUrl);

    // Assign image path to the input value so it can be used on server
    let inputPreviewImage = document.getElementById('inputPreviewImage');
    inputPreviewImage.value = imgUrl;

    // Get id of the reserved article
    let articleId = $(this).find(':selected').data('id');
    let reservedArticleId = document.getElementById('reservedArticleId');
    reservedArticleId.value = articleId;
  });

  // Search Articles in single table
  let articleListSingleTable = document.querySelector('#singleTableArticleList');
  let searchSingleTable = document.getElementById('searchArticleSingleTableInput');

  searchSingleTable.addEventListener('keyup', function(e) {
    let term = e.target.value.toLowerCase();
    let articles = articleListSingleTable.getElementsByTagName('li');
    Array.from(articles).forEach(function(article) {
      let articleName = article.querySelector('#articleNameSingleTable').textContent;
      // Display matching articles with colored background
      if(articleName.toLowerCase().indexOf(term) != -1){
        article.style.display = 'block';
        article.style.backgroundColor = 'LightGrey';
      }else{
        // Hide unmatching articles
        article.style.display = 'none';
      }
      if(term == ''){
        article.style.backgroundColor = '';
      }
    });
  });

  // Cancel reserving article
  function cancelArticleInput() {
    let parent = document.getElementById('currentOrderForm');
    let child = document.getElementById('reservedArticleDiv');
    parent.removeChild(child);
  };

  // Initialize materialize dropdown
  document.addEventListener('DOMContentLoaded', function() {
    let options;
    let elems = document.querySelectorAll('select');
    let instances = M.FormSelect.init(elems, options);
  });

</script>
